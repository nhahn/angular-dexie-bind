/*! angular-dexie-bind - v0.1.2 - 2015-07-16
* https://github.com/nhahn/angular-dexie-bind
* Copyright (c) 2015 Nathan Hahn; Licensed  */
function diff(a,b){return a.filter(function(a){return b.indexOf(a)<0})}!function(){function a(a){var b=function(a){return Array.prototype.slice.call(1===a.length&&Array.isArray(a[0])?a[0]:a)};a.WhereClause.prototype.anyOf=Dexie.override(a.WhereClause.prototype.anyOf,function(a){return function(){var c=a.apply(this,arguments);return c._ctx.anyOf=b(arguments),c}}),a.WhereClause.prototype.startsWithIgnoreCase=Dexie.override(a.WhereClause.prototype.startsWithIgnoreCase,function(a){return function(){var b=a.apply(this,arguments);return b._ctx.ignoreCase=!0,b}}),a.WhereClause.prototype.equalsIgnoreCase=Dexie.override(a.WhereClause.prototype.equalsIgnoreCase,function(a){return function(){var b=a.apply(this,arguments);return b._ctx.ignoreCase=!0,b}}),a.Collection.prototype.distinct=Dexie.override(a.Collection.prototype.distinct,function(a){return function(){var b=a.apply(this,arguments);return this._ctx.distinct=!0,b}})}Dexie.addons.push(a);var b=angular.module("ngDexieBind",[]);b.factory("$dexieBind",["$q","$rootScope","$timeout","$log",function(a,b,c,d){var e=function(){function b(a,c,d){var e={};if(a._ctx.distinct?e=Object.create(b.prototype):(e=Object.create(Array.prototype),e=Array.apply(e,d)||e,b.injectClassMethods(e)),Object.defineProperties(e,{$query:{value:a,writable:!0},$context:{value:a._ctx,writable:!0},$scope:{value:c,writable:!1},$joinListeners:{value:[],writable:!0},$listener:{value:function(){},writable:!0}}),a._ctx.distinct)for(var f=0;f<d.length;f++)e[d[f][a._ctx.table.schema.primKey.name]]=d[f];return e.$bind(),e.$scope.$on("$destroy",function(){e.$unbind()}),e}return b.injectClassMethods=function(a){for(var c in b.prototype)b.prototype.hasOwnProperty(c)&&Object.defineProperty(a,c,{enumberable:!1,configurable:!1,writable:!1,value:b.prototype[c]});return a},b.fromArray=function(a,c,d){var e=b.apply(null,[a,c,d]);return e},b.isArray=function(a){var b=Object.prototype.toString.call(a);return"[object array]"===b.toLowerCase()},b.prototype={$add:function(a){return this.$context.table.add(a)},$update:function(a,b){return this.$context.table.update(a,b)},$join:function(c,d,e,f){var g=this,h=new a.defer,i={};if(g.$context.distinct)for(var j in g)g.hasOwnProperty(j)&&"$"!==j.charAt(0)&&(i[j]=1);else for(var k=0;k<this.length;k++)i[this[k][d]]=1;var l=c.where(e).anyOf(Object.keys(i)).distinct();return f instanceof Function&&(l=l.and(f)),l.toArray().then(function(a){var a=b.fromArray(l,g.$scope,a);g.$joinListeners.push({set:a,thisField:d,thatField:e,filter:f}),h.resolve(a)})["catch"](function(a){h.reject(a)}),h.promise},$requery:function(){this.length=0;var a=this;return this.$context.toArray().then(function(b){a.$scope.$apply(function(){if(a.$context.distinct){Object.keys(a).each(function(b){"$"!==b.charAt(0)&&delete a[b]});for(var c=0;c<b.length;c++)a[b[c][a.$context.table.schema.primKey.name]]=b[c]}else{a.length=0;for(var c=0;c<b.length;c++)a[c]=b[c]}for(var c=0;c<a.$joinListeners.length;c++){var d=a.$joinListeners[c].set,e={};if(a.$context.distinct)for(var f in a)a.hasOwnProperty(f)&&"$"!==f.charAt(0)&&(e[f]=1);else for(var c=0;c<this.length;c++)e[a[c][a.$joinListeners[c].thisField]]=1;var g=d.$context.table.where(a.$joinListeners[c].thatField).anyOf(e).distinct();a.$joinListeners[c].filter instanceof Function&&(g=g.and(a.$joinListeners[c].filter)),d.$query=g,d.$context=g._ctx,d.$requery()}})})},$bind:function(){this.$listener=this.$listener_func()},$bind_to:function(a){var b=this;a.on("changes",function(a){b.$listener(a)})},$listener_func:function(){var a=this,b=function(b){for(var c=0;c<a.$joinListeners.length;c++){var d=a.$joinListeners[c].set;if(!d[b[d.$context.table.schema.primKey.name]]){var e=d.$context.anyOf;e.push(b[a.$joinListeners[c].thisField]);var f=d.$context.table.where(a.$joinListeners[c].thatField).anyOf(e).distinct(),g=d.$context.table.where(a.$joinListeners[c].thatField).equals(b[a.$joinListeners[c].thisField]).distinct();a.$joinListeners[c].filter instanceof Function&&(f=f.and(a.$joinListeners[c].filter),g=g.and(a.$joinListeners[c].filter)),d.$query=f,d.$context=f._ctx,function(b){g.toArray().then(function(c){a.$scope.$apply(function(){for(var a=0;a<c.length;a++)b[c[a][b.$context.table.schema.primKey.name]]||(b[c[a][b.$context.table.schema.primKey.name]]=c[a])})})}(d)}}};return function(c){for(var d=0;d<c.length;d++){for(var e=c[d],f=0;f<a.$joinListeners.length;f++)a.$joinListeners[f].set.$listener(c);if(e.table!=a.$context.table.name)return;a.$scope.$apply(function(){if(1==e.type){if(a.$context.distinct){if(a[e.key])return}else for(var c=0;c<a.length;c++)if(e.key==a[c][a.$context.table.schema.primKey.name])return;if(a.$context.or||0!=a.$context.offset)return void a.$requery();if(a.$filter(e))if(a.$context.distinct)a[e.key]=e.obj;else for(var c=0;c<a.length;c++)if("prev"==a.$context.dir){if(a[c][a.$context.index]<=e.obj[a.$context.index])return a.splice(c,0,e.obj),void b(e.obj)}else if(a[c][a.$context.index]>=e.obj[a.$context.index])return a.splice(c,0,e.obj),void b(e.obj)}else if(2==e.type){if(a.$context.distinct)a[e.key]&&a.$filter(e)&&(a[e.key]=e.obj,b(e.obj));else for(var c=0;c<a.length;c++)if(a[c][a.$context.table.schema.primKey.name]==e.key)return void(a.$filter(e)&&(a[c]=e.obj,b(e.obj)))}else if(3==e.type){if(a.$context.limit!=1/0)return void a.$requery();if(a.$context.distinct)delete a[e.key];else for(var c=0;c<a.length;c++)a[c][a.$context.table.schema.primKey.name]==e.key&&a.splice(c,1)}})}}},$unbind:function(){this.$listener=function(){}},$filter:function(a){if(this.$context.range){if(this.$context.range.lower)if(this.$context.range.lowerOpen){if(a.obj[this.$context.index]<=this.$context.range.lower)return!1}else if(a.obj[this.$context.index]<this.$context.range.lower)return!1;if(this.$context.range.upper)if(this.$context.range.upperOpen){if(a.obj[this.$context.index]>=this.$context.range.upper)return!1}else if(a.obj[this.$context.index]>this.$context.range.upper)return!1}if(this.$context.anyOf){for(var b=0;b<this.$context.anyOf.length;b++)if(a.obj[this.$context.index]==this.$context.anyOf[b])return!0;return!1}return this.$context.isMatch&&!this.$context.isMatch(a.obj)?!1:!0}},b}.call({}),f=function(b,c,d){var f=new a.defer,g=c._ctx.table,h=[];g.schema.mappedClass;return c.toArray().then(function(a){d.$apply(function(){h=e.fromArray(c,d,a),h.$bind_to(b),f.resolve(h)})})["catch"](function(a){d.$apply(function(){f.reject(a)})}),f.promise};return{bind:f}}])}(),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{enumerable:!1,configurable:!0,writable:!0,value:function(a){if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof a)throw new TypeError("predicate must be a function");for(var b,c=Object(this),d=c.length>>>0,e=arguments[1],f=0;d>f;f++)if(f in c&&(b=c[f],a.call(e,b,f,c)))return b;return void 0}}),Array.isArray||(Array.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)});